// Auto-generated from src/iterate.wat — do not edit by hand
const ITERATE_WASM = new Uint8Array([
  0,97,115,109,1,0,0,0,1,38,5,96,5,127,127,127,127,127,0,96,
  3,127,127,127,0,96,5,127,127,125,125,127,0,96,6,127,127,127,125,125,
  127,0,96,3,127,125,127,0,2,15,1,3,101,110,118,6,109,101,109,111,
  114,121,2,0,1,3,9,8,0,0,1,1,1,2,3,4,7,105,8,14,
  105,116,101,114,97,116,101,95,115,99,97,108,97,114,0,0,12,105,116,101,
  114,97,116,101,95,115,105,109,100,0,1,7,97,100,100,95,102,51,50,0,
  2,7,115,117,98,95,102,51,50,0,3,7,109,117,108,95,102,51,50,0,
  4,10,114,97,110,100,111,109,95,102,51,50,0,5,14,97,100,100,95,114,
  97,110,100,111,109,95,102,51,50,0,6,9,115,99,97,108,101,95,102,51,
  50,0,7,10,137,10,8,87,1,2,127,65,0,33,5,2,64,3,64,32,
  5,32,4,79,13,1,32,5,65,2,116,33,6,32,0,32,6,106,32,0,
  32,6,106,42,2,0,32,2,32,6,106,42,2,0,146,56,2,0,32,1,
  32,6,106,32,1,32,6,106,42,2,0,32,3,32,6,106,42,2,0,146,
  56,2,0,32,5,65,1,106,33,5,12,0,11,11,11,183,1,1,3,127,
  32,4,65,124,113,33,7,65,0,33,5,2,64,3,64,32,5,32,7,79,
  13,1,32,5,65,2,116,33,6,32,0,32,6,106,32,0,32,6,106,253,
  0,4,0,32,2,32,6,106,253,0,4,0,253,228,1,253,11,4,0,32,
  1,32,6,106,32,1,32,6,106,253,0,4,0,32,3,32,6,106,253,0,
  4,0,253,228,1,253,11,4,0,32,5,65,4,106,33,5,12,0,11,11,
  2,64,3,64,32,5,32,4,79,13,1,32,5,65,2,116,33,6,32,0,
  32,6,106,32,0,32,6,106,42,2,0,32,2,32,6,106,42,2,0,146,
  56,2,0,32,1,32,6,106,32,1,32,6,106,42,2,0,32,3,32,6,
  106,42,2,0,146,56,2,0,32,5,65,1,106,33,5,12,0,11,11,11,
  128,1,1,3,127,32,2,65,124,113,33,5,65,0,33,3,2,64,3,64,
  32,3,32,5,79,13,1,32,3,65,2,116,33,4,32,0,32,4,106,32,
  0,32,4,106,253,0,4,0,32,1,32,4,106,253,0,4,0,253,228,1,
  253,11,4,0,32,3,65,4,106,33,3,12,0,11,11,2,64,3,64,32,
  3,32,2,79,13,1,32,3,65,2,116,33,4,32,0,32,4,106,32,0,
  32,4,106,42,2,0,32,1,32,4,106,42,2,0,146,56,2,0,32,3,
  65,1,106,33,3,12,0,11,11,11,128,1,1,3,127,32,2,65,124,113,
  33,5,65,0,33,3,2,64,3,64,32,3,32,5,79,13,1,32,3,65,
  2,116,33,4,32,0,32,4,106,32,0,32,4,106,253,0,4,0,32,1,
  32,4,106,253,0,4,0,253,229,1,253,11,4,0,32,3,65,4,106,33,
  3,12,0,11,11,2,64,3,64,32,3,32,2,79,13,1,32,3,65,2,
  116,33,4,32,0,32,4,106,32,0,32,4,106,42,2,0,32,1,32,4,
  106,42,2,0,147,56,2,0,32,3,65,1,106,33,3,12,0,11,11,11,
  128,1,1,3,127,32,2,65,124,113,33,5,65,0,33,3,2,64,3,64,
  32,3,32,5,79,13,1,32,3,65,2,116,33,4,32,0,32,4,106,32,
  0,32,4,106,253,0,4,0,32,1,32,4,106,253,0,4,0,253,230,1,
  253,11,4,0,32,3,65,4,106,33,3,12,0,11,11,2,64,3,64,32,
  3,32,2,79,13,1,32,3,65,2,116,33,4,32,0,32,4,106,32,0,
  32,4,106,42,2,0,32,1,32,4,106,42,2,0,148,56,2,0,32,3,
  65,1,106,33,3,12,0,11,11,11,238,1,3,3,127,7,123,1,127,65,
  141,204,229,0,253,17,33,9,65,223,230,187,227,3,253,17,33,10,67,0,
  0,128,51,253,19,33,11,32,2,253,19,33,12,32,3,253,19,33,13,32,
  1,253,0,4,0,33,8,32,4,65,124,113,33,7,65,0,33,5,2,64,
  3,64,32,5,32,7,79,13,1,32,5,65,2,116,33,6,32,8,32,9,
  253,181,1,32,10,253,174,1,33,8,32,8,65,8,253,173,1,253,251,1,
  32,11,253,230,1,32,13,253,230,1,32,12,253,228,1,33,14,32,0,32,
  6,106,32,14,253,11,4,0,32,5,65,4,106,33,5,12,0,11,11,32,
  1,32,8,253,11,4,0,2,64,3,64,32,5,32,4,79,13,1,32,5,
  65,2,116,33,6,32,1,40,2,0,65,141,204,229,0,108,65,223,230,187,
  227,3,106,33,15,32,1,32,15,54,2,0,32,0,32,6,106,32,15,65,
  8,118,179,67,0,0,128,51,148,32,3,148,32,2,146,56,2,0,32,5,
  65,1,106,33,5,12,0,11,11,11,131,2,3,3,127,7,123,1,127,65,
  141,204,229,0,253,17,33,10,65,223,230,187,227,3,253,17,33,11,67,0,
  0,128,51,253,19,33,12,32,3,253,19,33,13,32,4,253,19,33,14,32,
  2,253,0,4,0,33,9,32,5,65,124,113,33,8,65,0,33,6,2,64,
  3,64,32,6,32,8,79,13,1,32,6,65,2,116,33,7,32,9,32,10,
  253,181,1,32,11,253,174,1,33,9,32,9,65,8,253,173,1,253,251,1,
  32,12,253,230,1,32,14,253,230,1,32,13,253,228,1,32,1,32,7,106,
  253,0,4,0,253,228,1,33,15,32,0,32,7,106,32,15,253,11,4,0,
  32,6,65,4,106,33,6,12,0,11,11,32,2,32,9,253,11,4,0,2,
  64,3,64,32,6,32,5,79,13,1,32,6,65,2,116,33,7,32,2,40,
  2,0,65,141,204,229,0,108,65,223,230,187,227,3,106,33,16,32,2,32,
  16,54,2,0,32,0,32,7,106,32,16,65,8,118,179,67,0,0,128,51,
  148,32,4,148,32,3,146,32,1,32,7,106,42,2,0,146,56,2,0,32,
  6,65,1,106,33,6,12,0,11,11,11,123,2,3,127,1,123,32,1,253,
  19,33,6,32,2,65,124,113,33,5,65,0,33,3,2,64,3,64,32,3,
  32,5,79,13,1,32,3,65,2,116,33,4,32,0,32,4,106,32,0,32,
  4,106,253,0,4,0,32,6,253,230,1,253,11,4,0,32,3,65,4,106,
  33,3,12,0,11,11,2,64,3,64,32,3,32,2,79,13,1,32,3,65,
  2,116,33,4,32,0,32,4,106,32,0,32,4,106,42,2,0,32,1,148,
  56,2,0,32,3,65,1,106,33,3,12,0,11,11,11
]); // 1475 bytes

export interface IterateKernels {
  iterate_scalar(px: number, py: number, vx: number, vy: number, count: number): void;
  iterate_simd(px: number, py: number, vx: number, vy: number, count: number): void;
  add_f32(dst: number, src: number, count: number): void;
  sub_f32(dst: number, src: number, count: number): void;
  mul_f32(dst: number, src: number, count: number): void;
  scale_f32(dst: number, scalar: number, count: number): void;
  random_f32(dst: number, state: number, min: number, range: number, count: number): void;
  add_random_f32(dst: number, src: number, state: number, min: number, range: number, count: number): void;
}

// Cached compiled module (shared across all EntityManager instances)
let cachedModule: WebAssembly.Module | null = null;

function getCompiledModule(): WebAssembly.Module {
  if (!cachedModule) {
    cachedModule = new WebAssembly.Module(ITERATE_WASM);
  }
  return cachedModule;
}

/** Returns true if the runtime supports WebAssembly SIMD. Result is cached. */
export function isWasmSimdAvailable(): boolean {
  if (cachedModule !== null) return true;
  try {
    getCompiledModule();
    return true;
  } catch {
    return false;
  }
}

export async function instantiateKernels(memory: WebAssembly.Memory): Promise<IterateKernels> {
  const module = getCompiledModule();
  const instance = await WebAssembly.instantiate(module, { env: { memory } });
  return instance.exports as unknown as IterateKernels;
}

/** Synchronous instantiation — only for small modules (<4KB). Used internally. */
export function instantiateKernelsSync(memory: WebAssembly.Memory): IterateKernels {
  const module = getCompiledModule();
  const instance = new WebAssembly.Instance(module, { env: { memory } });
  return instance.exports as unknown as IterateKernels;
}
